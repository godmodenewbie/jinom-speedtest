<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jinom Speedtest</title>
<style>
  :root{
    --bg:#0f1320; --card:#171b2b; --muted:#9aa3c7; --text:#e8ebff; --accent:#5b8cff; --accent2:#7a9dff;
    --good:#3cd278; --warn:#f7b955; --bad:#ff6b6b; --bar:#2a2f47;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font:14px system-ui,Segoe UI,Roboto,Inter,Arial;background:radial-gradient(1200px 800px at 70% -10%, #1a2040 0%, #0f1320 45%, #0b0e1b 100%);color:var(--text)}
  a{color:var(--accent)}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  .nav{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .brand{font-weight:700;letter-spacing:.2px}
  .tag{font-size:12px;color:var(--muted)}
  .card{background:rgba(23,27,43,.9);backdrop-filter: blur(4px);padding:14px;border:1px solid #222842;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .row{display:grid;gap:14px}
  @media (min-width:900px){ .row-3{grid-template-columns: 1.3fr .7fr} }
  .controls{display:grid;gap:10px}
  .field{display:grid;gap:6px}
  label{font-size:12px;color:var(--muted)}
  input,select,button{background:#0e1220;border:1px solid #222842;color:var(--text);padding:10px;border-radius:10px}
  input:disabled,select:disabled,button:disabled{opacity:.6;cursor:not-allowed}
  button.btn{background:linear-gradient(180deg, var(--accent), var(--accent2));border:0;color:#fff;font-weight:600;cursor:pointer}
  button.btn.secondary{background:#0e1220;color:#cfd6ff;border:1px solid #2a2f47}
  .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media (min-width:600px){.kpis{grid-template-columns:repeat(4,1fr)}}
  .kpi{background:#0e1220;border:1px solid #222842;border-radius:14px;padding:12px;text-align:center}
  .kpi .label{font-size:12px;color:var(--muted);margin-bottom:6px}
  .kpi .val{font-size:26px;font-weight:700}
  .kpi .unit{font-size:12px;color:var(--muted);margin-left:4px}
  .bars{display:grid;gap:10px;margin-top:10px}
  .bar{height:10px;background:var(--bar);border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%}
  .server{font-size:13px;color:var(--muted)}
  .log{white-space:pre-wrap;font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px;color:#b9c2e2;max-height:120px;overflow:auto}

  /* Gauge */
  .gauge{position:relative;aspect-ratio:1/1;max-width:520px;margin:auto}
  .gauge svg{display:block;width:100%;height:auto}
  .speed-value{position:absolute;inset:auto 0 26% 0;text-align:center}
  .speed-value .num{font-size:48px;font-weight:800}
  .speed-value .unit{font-size:14px;color:var(--muted)}
  .scale-label{position:absolute;left:50%;transform:translateX(-50%);bottom:8px;font-size:12px;color:var(--muted)}
  .btns{display:flex;gap:10px;justify-content:center;margin-top:10px}

  .pill{display:inline-flex;align-items:center;gap:6px;background:#0e1220;border:1px solid #222842;border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
  .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="nav">
      <div style="display:flex;align-items:center;gap:10px">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M12 3a9 9 0 1 0 9 9" stroke="#7a9dff" stroke-width="2"/><path d="M21 5l-7 7" stroke="#3cd278" stroke-width="2"/></svg>
        <div>
          <div class="brand">Jinom Speedtest</div>
          <div class="tag">Ookla-inspired UI (no branding/assets)</div>
        </div>
      </div>
      <div style="margin-left:auto" class="pill" id="statusPill">Ready</div>
    </div>

    <div class="row row-3">
      <div class="card">
        <div class="gauge">
          <svg id="gaugeSvg" viewBox="-120 -120 240 240" aria-hidden="true">
            <defs>
              <linearGradient id="grad" x1="0" x2="1">
                <stop offset="0%" stop-color="#5b8cff"/>
                <stop offset="100%" stop-color="#7a9dff"/>
              </linearGradient>
            </defs>
            <!-- arc background -->
            <path id="arcBg" d="" stroke="#1f2540" stroke-width="16" fill="none" stroke-linecap="round"/>
            <!-- ticks group -->
            <g id="ticks"></g>
            <!-- active arc -->
            <path id="arcVal" d="" stroke="url(#grad)" stroke-width="16" fill="none" stroke-linecap="round"/>
            <!-- needle -->
            <g id="needle" transform="rotate(-130)">
              <circle cx="0" cy="0" r="4" fill="#cfd6ff"/>
              <rect x="-2" y="-80" width="4" height="86" rx="2" fill="#cfd6ff"/>
            </g>
          </svg>
          <div class="speed-value">
            <div class="num" id="speedNum">0.00</div>
            <div class="unit">Mbps</div>
          </div>
          <div class="scale-label" id="scaleLabel">Scale: 0–1000 Mbps (Auto)</div>
        </div>
        <div class="btns">
          <button class="btn" id="btnStart">Start</button>
          <button class="btn secondary" id="btnStop" disabled>Stop</button>
        </div>
        <div class="kpis" style="margin-top:12px">
          <div class="kpi"><div class="label">Ping</div><div class="val"><span id="latency">-</span><span class="unit">ms</span></div></div>
          <div class="kpi"><div class="label">Jitter</div><div class="val"><span id="jitter">-</span><span class="unit">ms</span></div></div>
          <div class="kpi"><div class="label">Download</div><div class="val"><span id="downMbps">-</span><span class="unit">Mbps</span></div></div>
          <div class="kpi"><div class="label">Upload</div><div class="val"><span id="upMbps">-</span><span class="unit">Mbps</span></div></div>
        </div>
        <div class="bars">
          <div class="bar"><span id="downBar"></span></div>
          <div class="bar"><span id="upBar"></span></div>
        </div>
      </div>

      <div class="card">
        <div class="controls">
          
          <div class="field">
            <button id="btnLoad">Load Servers</button>
          </div>
          <div class="field">
            <label>Server</label>
            <select id="serverSelect"></select>
            <div class="server" id="serverInfo">No server selected</div>
          </div>
          <div class="field">
            <button id="btnProbe">Auto-pick by lowest ping</button>
          </div>
          <div class="field">
            <label>Duration / Streams</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <input id="duration" type="number" min="3" max="30" value="10" />
              <input id="streams" type="number" min="1" max="32" value="8" />
            </div>
          </div>
          <div class="field">
            <label>Log</label>
            <div class="log" id="log"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);
const state = { servers: [], selected: null, stopFlag: false, downBytes: 0, upBytes: 0, gaugeMax: 1000 };

function log(msg){ const el=$("log"); el.textContent = (msg+"\n"+el.textContent).slice(0, 5000); }
function mbps(bytes, seconds){ return (bytes * 8) / (seconds * 1e6); }
function fmt(n, d=2){ return Number(n).toFixed(d); }

// --- Gauge ---
const GAUGE = { start:-130, end:130 };
function polarToXY(r, ang){ const a = (ang-90)*Math.PI/180; return { x: r*Math.cos(a), y: r*Math.sin(a) }; }
function gaugePath(r, a0, a1){ const p0=polarToXY(r,a0), p1=polarToXY(r,a1); const large = (a1-a0)>180 ? 1:0; return `M ${p0.x} ${p0.y} A ${r} ${r} 0 ${large} 1 ${p1.x} ${p1.y}`; }
function setupGauge(){
  const bg = $("arcBg"), val=$("arcVal"), ticks = $("ticks");
  bg.setAttribute('d', gaugePath(90, GAUGE.start, GAUGE.end));
  val.setAttribute('d', gaugePath(90, GAUGE.start, GAUGE.start));
  drawTicks();
}
function drawTicks(){
  const g = $("ticks"); g.innerHTML = '';
  const max = state.gaugeMax; const steps = [0, .1, .2, .3, .4, .5, .6, .7, .8, .9, 1];
  steps.forEach(fr => {
    const ang = GAUGE.start + (GAUGE.end-GAUGE.start)*fr;
    const p0 = polarToXY(84, ang), p1 = polarToXY(92, ang);
    const txt = polarToXY(72, ang);
    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1', p0.x); line.setAttribute('y1', p0.y); line.setAttribute('x2', p1.x); line.setAttribute('y2', p1.y);
    line.setAttribute('stroke', fr%0.5===0? '#cfd6ff':'#3a4164'); line.setAttribute('stroke-width', fr%0.5===0? 2:1);
    g.appendChild(line);
    if(fr%0.5===0){
      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x', txt.x); label.setAttribute('y', txt.y+4);
      label.setAttribute('text-anchor','middle'); label.setAttribute('fill','#9aa3c7'); label.setAttribute('font-size','8');
      label.textContent = Math.round(max*fr);
      g.appendChild(label);
    }
  });
  $("scaleLabel").textContent = `Scale: 0–${max} Mbps (Auto)`;
}
function setGaugeMax(max){ state.gaugeMax = max; drawTicks(); }
function chooseScaleFor(mbps){
  const levels=[50,100,250,500,1000,2000,5000,10000,20000];
  for(const lv of levels){ if(mbps <= lv*0.85) return lv; }
  return levels[levels.length-1];
}
function updateGauge(currentMbps){
  // autoscale if needed
  const need = chooseScaleFor(currentMbps);
  if(need !== state.gaugeMax){ setGaugeMax(need); }
  const frac = Math.max(0, Math.min(1, currentMbps / state.gaugeMax));
  const ang = GAUGE.start + (GAUGE.end-GAUGE.start)*frac;
  $("needle").setAttribute('transform', `rotate(${ang})`);
  $("arcVal").setAttribute('d', gaugePath(90, GAUGE.start, ang));
  $("speedNum").textContent = fmt(currentMbps, 2);
}

// --- Networking helpers ---
async function fetchServers(){
  const dir = $("dirUrl").value.trim().replace(/\/+$/,'');
  const r = await fetch(dir + "/api/v1/servers", { cache: 'no-store' });
  const servers = await r.json();
  state.servers = servers;
  const sel = $("serverSelect"); sel.innerHTML = '';
  servers.forEach((s,i)=>{ const opt=document.createElement('option'); opt.value=String(i); opt.textContent=`${s.city||''} (${s.region||''}) – ${s.url}`; sel.appendChild(opt); });
  if(servers.length){ sel.value='0'; state.selected=servers[0]; $("serverInfo").textContent = `Selected: ${servers[0].city||''} • ${servers[0].url}`; }
  log(`Loaded ${servers.length} server(s).`);
}
function setSelectedFromSelect(){ const idx=parseInt($("serverSelect").value||'0',10); state.selected = state.servers[idx]; $("serverInfo").textContent = `Selected: ${state.selected.city||''} • ${state.selected.url}`; }

async function measureLatency(baseUrl, count=10){
  const samples=[]; for(let i=0;i<count;i++){ const t0=performance.now(); await fetch(baseUrl+"/api/v1/latency?t="+Math.random(), { cache: 'no-store' }); samples.push(performance.now()-t0); }
  const avg=samples.reduce((a,b)=>a+b,0)/samples.length; const mean=avg; const jitter=Math.sqrt(samples.reduce((s,x)=>s+Math.pow(x-mean,2),0)/samples.length);
  return { avg, jitter, samples };
}

async function probeBest(){ if(!state.servers.length) return; $("statusPill").textContent='Probing…';
  const tests = await Promise.all(state.servers.map(s=>measureLatency(s.URL||s.url,6).then(r=>({s,r})).catch(()=>({s,r:null}))));
  tests.sort((a,b)=> (a.r? a.r.avg:1e9)-(b.r? b.r.avg:1e9));
  const best=tests[0]; if(best&&best.r){ state.selected=best.s; $("serverInfo").textContent = `Best by ping: ${best.s.city} (${best.s.region}) • avg ${best.r.avg.toFixed(1)} ms`; const idx=state.servers.findIndex(x=>x.id===best.s.id); if(idx>=0) $("serverSelect").value=String(idx); $("latency").textContent = best.r.avg.toFixed(1); $("jitter").textContent = best.r.jitter.toFixed(1); }
  $("statusPill").textContent='Ready';
}

// Download multi-stream
async function runDownload(baseUrl, seconds=10, streams=8, onProgress=()=>{}){
  const tEnd = Date.now() + seconds*1000; let total=0; state.downBytes=0;
  const worker = async ()=>{ while(Date.now()<tEnd && !state.stopFlag){ const resp=await fetch(baseUrl+"/api/v1/download?time=2", { cache:'no-store' }); const reader=resp.body.getReader(); for(;;){ const {value,done}=await reader.read(); if(done) break; total+=value.byteLength; state.downBytes+=value.byteLength; if(Date.now()>=tEnd||state.stopFlag){ try{reader.cancel()}catch{} break; } } } };
  const tick=setInterval(()=>onProgress(total), 120);
  await Promise.all(Array.from({length:streams}, worker)); clearInterval(tick); onProgress(total); return total;
}

// Upload helpers
function supportsStreamingUpload(){ try{ const rs=new ReadableStream({start(c){c.close()}}); new Request('about:blank',{method:'POST',body:rs,duplex:'half'}); return true; }catch{return false} }
function makeUploadStream(durationMs,onEnq){ const end=Date.now()+durationMs; const chunk=new Uint8Array(1<<20); (self.crypto||window.crypto).getRandomValues(chunk); return new ReadableStream({ pull(c){ if(Date.now()>=end || state.stopFlag){ c.close(); return } c.enqueue(chunk); if(onEnq) onEnq(chunk.length); } }); }
async function runUploadFallback(baseUrl, seconds=10, streams=4, onProgress=()=>{}){ const tEnd=Date.now()+seconds*1000; const body=new Uint8Array(1<<20); (self.crypto||window.crypto).getRandomValues(body); let total=0; const worker=async()=>{ while(Date.now()<tEnd && !state.stopFlag){ await fetch(baseUrl+"/api/v1/upload",{method:'POST',headers:{'Content-Type':'application/octet-stream'},body}).catch(()=>{}); total+=body.byteLength; onProgress(total); } return total; }; const results=await Promise.all(Array.from({length:streams}, worker)); return results.reduce((a,b)=>a+b,0); }
async function runUpload(baseUrl, seconds=10, streams=8, onProgress=()=>{}){
  state.upBytes=0; const durationMs=seconds*1000;
  if(supportsStreamingUpload()){
    const worker=async()=>{ try{ const stream=makeUploadStream(durationMs, n=>{state.upBytes+=n; onProgress(state.upBytes)}); const r=await fetch(baseUrl+`/api/v1/upload?time=${seconds}`,{method:'POST',headers:{'Content-Type':'application/octet-stream'},body:stream,duplex:'half'}); const j=await r.json().catch(()=>({receivedBytes:0})); state.upBytes += (j.receivedBytes||0); return j.receivedBytes||0; }catch(e){ return 0; } };
    const tick=setInterval(()=>onProgress(state.upBytes),120);
    const results=await Promise.all(Array.from({length:streams}, worker)); clearInterval(tick); const sum=results.reduce((a,b)=>a+b,0); onProgress(state.upBytes); if(sum>0) return sum;
  }
  // fallback
  const fb=await runUploadFallback(baseUrl,seconds,Math.max(1,Math.min(8,streams)), n=>{state.upBytes=n; onProgress(n)}); return fb;
}

function setRunning(r){ $("btnStart").disabled=r; $("btnStop").disabled=!r; $("statusPill").textContent = r? 'Testing…':'Ready'; }

async function startTest(){ try{
  if(!state.selected){ await fetchServers(); if(!state.selected){ alert('Tidak ada server tersedia.'); return; } }
  setRunning(true); state.stopFlag=false; $("downBar").style.width='0%'; $("upBar").style.width='0%'; $("downMbps").textContent='-'; $("upMbps").textContent='-'; $("latency").textContent='-'; $("jitter").textContent='-'; updateGauge(0); log('Measuring latency…');
  const base = state.selected.URL || state.selected.url; const seconds=Math.max(3,Math.min(30, parseInt($("duration").value||'10',10))); const streams=Math.max(1,Math.min(32, parseInt($("streams").value||'8',10)));
  const lat = await measureLatency(base, 10); $("latency").textContent = lat.avg.toFixed(1); $("jitter").textContent = lat.jitter.toFixed(1);
  log('Running download…'); const t0d=performance.now(); await runDownload(base, seconds, streams, (bytes)=>{ const elapsed=(performance.now()-t0d)/1000; const m=mbps(bytes, Math.max(elapsed, .001)); $("downMbps").textContent=fmt(m,2); $("downBar").style.width = Math.min(100,(elapsed/seconds)*100)+'%'; updateGauge(m); });
  log('Running upload…'); const t0u=performance.now(); await runUpload(base, seconds, streams, (bytes)=>{ const elapsed=(performance.now()-t0u)/1000; const m=mbps(bytes, Math.max(elapsed, .001)); $("upMbps").textContent=fmt(m,2); $("upBar").style.width = Math.min(100,(elapsed/seconds)*100)+'%'; updateGauge(m); });
  log('Done.');
} catch(e){ console.error(e); log('Error: '+e.message) } finally { setRunning(false) } }
function stopTest(){ state.stopFlag=true; setRunning(false); log('Stopped.'); }

window.addEventListener('DOMContentLoaded', ()=>{
  setupGauge(); setGaugeMax(1000); // start at 1 G scale
  $("btnLoad").onclick = fetchServers;
  $("serverSelect").onchange = setSelectedFromSelect;
  $("btnProbe").onclick = probeBest;
  $("btnStart").onclick = startTest;
  $("btnStop").onclick = stopTest;
  // auto load once
  fetchServers().catch(()=>{});
});
</script>
</body>
</html>
